# Ansible for monitoring infrastructure

## Description

This folder contains the Ansible playbook to install and configure the monitoring infrastructure. The monitoring infrastructure is composed of the following components:

- Prometheus
- Grafana
- Node Exporter
- PVE Exporter

## Requirements

Docker or ansible installed on the running machine. Having sudo privileges on the machine you want to monitor and have a root password for proxmox.

## Usage

### Docker

Using Docker is simpler and doesn't require any installation of dependencies on the host machine.

To run the monitoring infrastructure using Docker, execute the following command:

```bash
docker compose run --rm ansible
```

This command will run the Ansible container to run the playbook follow the instructions in the next section. The required collections are already installed in the container.

### Ansible

If you aren't using the container, you need to install the required collections:

```bash
ansible-galaxy collection install prometheus.prometheus

ansible-galaxy collection install community.grafana
```

## Running the playbooks

### Configuration of the inventory

```bash
ansible-playbook -i hosts_unconfigured --ask-pass -K setup_ansible.yml
```

## Add monitoring

Before running the monitoring playbook, you need to add the ssh key to your ssh-agent. All the key generated by the playbook are stored in the `~/.ssh/` folder.

```bash
ansible-playbook monitoring.yml
```

## Add proxmox monitoring

Connection with ssh password is required to add the monitoring of the proxmox server. Connection to root to have permission to create and add user sur ACL.

```bash
ansible-playbook proxmox.yml --ask-pass
```

-A PREROUTING -i vmbr0 -p tcp -m tcp --dport 2006 -j DNAT --to-destination 10.0.0.6:22
-A PREROUTING -i vmbr0 -p tcp -m tcp --dport 3000 -j DNAT --to-destination 10.0.0.6:3000
